name: End to end testing

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:

  dusk-browser-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install Composer Dependencies
        run: composer install --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

      - name: Prepare the Environment
        run: echo -e "APP_URL=http://localhost:8080 \nDUSK_ENABLED=true" > .env

      - name: Upgrade Chrome Driver
        run: php hyde dusk:chrome-driver `/opt/google/chrome/chrome --version | cut -d " " -f3 | cut -d "." -f1`
      - name: Start Chrome Driver
        run: ./vendor/laravel/dusk/bin/chromedriver-linux &

      - name: Run HydeRC Server
        run: php hyde serve &

      - name: Run Dusk Tests
        env:
          APP_URL: "http://127.0.0.1:8080"
        run: php hyde dusk --pest

      - name: Upload Screenshots
        uses: actions/upload-artifact@v2
        with:
          name: screenshots
          path: tests/Browser/screenshots

      - name: Upload Compiled Source
        uses: actions/upload-artifact@v2
        with:
          name: dusk-source
          path: tests/Browser/source

      - name: Upload Console Logs
        if: failure()
        uses: actions/upload-artifact@v2
        with:
          name: dusk-console
          path: tests/Browser/console


  build-tailwindcss:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        cache: 'npm'

    - name: Install Node.js dependencies
      run: npm ci

    - name: Update Tailwind content path
      run: sed -i 's/\.\/vendor\/hyde\/framework\/resources\/views\/\*\*\/\*\.blade\.php/\.\/packages\/framework\/resources\/views\/\*\*\/\*\.blade\.php/' tailwind.config.js

    - name: Build assets for production
      run: npm run prod

    - name: Upload artifacts
      uses: actions/upload-artifact@v1
      with:
        name: 'app.css'
        path: '_media/app.css'


  visual-regression-testing:
    runs-on: ubuntu-latest
    needs: [dusk-browser-tests, build-tailwindcss]
    steps:
      - name: Download Dusk generated pages
        uses: actions/download-artifact@v2
        with:
          name: dusk-source
          path: _site
          
      # @TODO compile latest hydefront version
      - name: Download app.css
        uses: actions/download-artifact@v2
        with:
          name: app.css
          path: _site/media/app.css

      - name: Upload build to Percy
        run: npx percy snapshot _site/
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
